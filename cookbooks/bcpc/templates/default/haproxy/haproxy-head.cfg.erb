################################################
#
#              Generated by Chef
#
################################################
<%# include the globals %>
<%= render "haproxy/haproxy-head.globals.cfg.partial.erb", :variables => {:node => node} -%>

<%# include the defaults %>
<%= render "haproxy/haproxy-head.defaults.cfg.partial.erb", :variables => {:node => node} -%>

<%
  inherited_vars = {node: node}
  # Partials attributes all indexed via strings
  @partials.each do |fragment, attrs|
    partial_vars = inherited_vars.merge attrs["variables"]
    cookbook = attrs["cookbook"] || cookbook_name
%>
<%= render fragment, :variables => partial_vars, :cookbook => cookbook %>
<% end %>

<% if node['bcpc']['enabled']['neutron'] %>
<%= render "haproxy/haproxy-head.neutron.cfg.partial.erb", :variables => {:node => node} -%>
<% end %>

frontend http
  bind <%=node['bcpc']['management']['vip']%>:80
  option tcplog
  default_backend http-backend

frontend https
  bind <%=node['bcpc']['management']['vip']%>:443 ssl crt /etc/haproxy/haproxy.pem
  option tcplog
  stats enable
  stats uri /haproxy
  stats hide-version
  stats realm Haproxy\ Statistics
  stats auth <%=get_config('haproxy-stats-user')%>:<%=get_config('haproxy-stats-password')%>
  reqadd X-Forwarded-Protocol:\ https
  acl url_horizon path_beg /horizon
  use_backend horizon-backend if url_horizon
  acl url_horizon_static path_beg /static
  use_backend horizon-backend if url_horizon_static
  acl url_rabbitmq path_beg /rabbitmq
  use_backend rabbitmq-web-backend if url_rabbitmq
  default_backend http-backend

backend http-backend
  balance source
  option httpchk GET /
  http-check expect status 200
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:80 check inter 5s rise 1 fall 1" %>
<% end -%>
