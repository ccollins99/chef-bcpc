listen keystone-api
  bind <%=node['bcpc']['management']['vip']%>:5000 <%= (node['bcpc']['protocol']['keystone'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  balance source
  option tcplog
  option httpchk GET /
  http-check expect status 300
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:5000 check inter 5s rise 1 fall 1" %>
<% end -%>

frontend keystone-admin
  bind <%=node['bcpc']['management']['vip']%>:35357 <%= (node['bcpc']['protocol']['keystone'] == 'https') ? "ssl crt /etc/haproxy/haproxy.pem" : "" %>
  option tcplog
  default_backend keystone-admin-backend

frontend keystone-admin-httponly
  bind <%=node['bcpc']['management']['vip']%>:35358
  option tcplog
  default_backend keystone-admin-backend

backend keystone-admin-backend
  balance source
  option httpchk GET /
  http-check expect status 300
<% @servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:35357 check inter 5s rise 1 fall 1" %>
<% end -%>
